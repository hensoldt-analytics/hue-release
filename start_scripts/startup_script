#!/bin/bash
# startup script
# chkconfig: 345 98 1
# description: startup script

NAME="startup_script"
LOG="/var/log/startup_script.log"
SCRIPTS_PATH="/home/sandbox/start_scripts"

PATH="/sbin:/usr/sbin:/bin:/usr/bin"
export PATH

source $SCRIPTS_PATH/consts.sh

function restart() {
    date >> $LOG
    [ "$1" == "-r" ] && str="Stopping HDP..." || str="Starting HDP..."
    printf "%-70s\n" "$str" | tee -a $LOG
    bash $SCRIPTS_PATH/stop.sh >> $LOG 2>&1

    [ "$1" == "-r" ] && printf "%-70s\n" "Starting HDP..." | tee -a $LOG
    bash $SCRIPTS_PATH/start.sh >> $LOG 2>&1
}


case "$1" in
start)
    printf "%-50s\n" "Starting $NAME..." | tee -a $LOG
    
    mkdir /var/www/landing 2> /dev/null
    mount --bind /home/sandbox/sandbox-tutorials /var/www/landing

    echo "" > /etc/resolv.conf
    ethtool -K eth0 tso off
    ethtool -K eth1 tso off
    dhclient &

    /etc/init.d/mysqld start >> $LOG  #To make run.sh work (tutorials update)

    #bash $SCRIPTS_PATH/sandbox_component_versions.sh

    printf "%-50s\n" "Updating IP..." | tee -a $LOG
    bash $SCRIPTS_PATH/gen_hosts.sh
   
    touch /home/sandbox/tutorials/registration_post.log
    chown sandbox:sandbox /home/sandbox/tutorials/registration_post.log

    /home/sandbox/tutorials/.env/bin/python \
        /home/sandbox/start_scripts/registration_post.py

    sed -i 1i"nameserver 8.8.8.8" /etc/resolv.conf

    if [ -d /home/sandbox/sandbox-shared ]; then
        printf "%-50s\n" "Updating sandbox..." | tee -a $LOG
        cd /home/sandbox/sandbox-shared

        sudo -u sandbox git fetch >> /var/log/startup_script.log 2>&1
        sudo -u sandbox git checkout $BRANCH >> /var/log/startup_script.log 2>&1
        sudo -u sandbox git stash  >> /var/log/startup_script.log 2>&1
        pull_res=$(sudo -u sandbox git pull origin $BRANCH 2>> $LOG)
        echo $pull_res >> $LOG

        chown sandbox:sandbox -R /home/sandbox/sandbox-shared
        [ ! "$pull_res" = "Already up-to-date." ] && /home/sandbox/hue/build/env/bin/hue migrate  >> $LOG 2>&1
    fi
    
    echo "Starting HDP ..."
    make --makefile $SCRIPTS_PATH/start_deps.mf -B Startup -j -i

    sudo -u hdfs hadoop dfsadmin -safemode leave
    
    printf "%-50s\n" "Starting sandbox..." | tee -a $LOG
    /etc/init.d/supervisord start >> $LOG 2>&1
    
    echo 0 > /proc/sys/kernel/hung_task_timeout_secs

    
    echo "You can now launch sandbox on http://$(getent ahosts `hostname` | awk '{print $1}' | head -n 1):8888/"
    stty -F /dev/tty1 -echo
    #open -c 1 -f -- python /home/sandbox/start_scripts/splash.py
;;
stop)
    date >> $LOG
    bash $SCRIPTS_PATH/stop.sh >> $LOG 2>&1
    /etc/init.d/supervisord stop >> $LOG 2>&1
;;

restart)
    restart -r
;;

*)
        echo "Usage: $0 {start|stop|restart}"
        exit 1
esac
